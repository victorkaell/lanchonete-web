<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />
<link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />
<script
    src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons"
    rel="stylesheet" />
<link rel="icon" href="logochapinha.ico" />
<title>Na Chapa</title>
</head>
<body>
    <nav class="grey darken-2">
        <div class="nav-wrapper container">
            <a href="#" class="brand-logo"><strong>Na Chapa</strong></a>
            <ul id="nav-mobile" class="right hide-on-med-and-down">
                <li><a href="#"><i class="material-icons">search</i></a></li>
                <li><a href="#"><i class="material-icons">local_mall</i></a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <h3>Cardápio</h3>
        <div class="row" id="menu-container">

            <div class="col s12 m3" th:each="produto : ${produtos}">

                <a th:href="|#modal-${produto.id}|" style="color: black"
                    class="modal-trigger">
                    <div class="card">
                        <div class="card-image">
                            <img th:src="${produto.imagemUrl}" th:alt="${produto.nome}" />
                        </div>
                        <div class="card-content">
                            <p th:text="${produto.nome}">Nome do Produto</p>
                            <p>
                                <strong>R$ <span
                                    th:text="${#numbers.formatDecimal(produto.precoBase, 1, 2, 'COMMA')}">20.00</span></strong>
                            </p>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <div id="modal-container">

        <div th:each="produto : ${produtos}" th:id="|modal-${produto.id}|"
            class="modal" th:attr="data-preco-base=${produto.precoBase}">
            <div class="modal-content">
                <h4 th:text="${produto.nome}">Nome Produto</h4>
                <h5>
                    Preço Base: R$ <span
                        th:text="${#numbers.formatDecimal(produto.precoBase, 1, 2, 'COMMA')}">20.00</span>
                </h5>
                <p>Selecione seus adicionais:</p>

                <p th:each="adicional : ${produto.adicionais}">
                    <label> <input type="checkbox" class="adicional-check"
                        th:attr="data-preco=${adicional.preco}"
                        th:onchange="|calcularPreco('#modal-${produto.id}')|" /> <span>
                            <span th:text="${adicional.nome}">Adicional</span> (+ R$ <span
                            th:text="${#numbers.formatDecimal(adicional.preco, 1, 2, 'COMMA')}">3.00</span>)
                    </span>
                    </label>
                </p>
                <div class="divider" style="margin: 20px 0;"></div>

                <h4>
                    Total: <span class="preco-total blue-text text-darken-2"> R$
                        <span class="preco-valor"
                        th:text="${#numbers.formatDecimal(produto.precoBase, 1, 2, 'COMMA')}">20.00</span>
                    </span>
                </h4>
            </div>

            <div class="modal-footer">
                <a href="#!" class="modal-close waves-effect waves-grey btn-flat">Cancelar</a>
                
                <a href="#!" class="modal-close waves-effect waves-green btn"
                   th:onclick="|adicionarAoCarrinho(${produto.id})|">Adicionar
                    ao Pedido</a>
            </div>
        </div>
    </div>

    <script>
    // (1) FUNÇÃO PARA CALCULAR O PREÇO DINÂMICO
    function calcularPreco(modalId) {
        const modal = document.querySelector(modalId);
        const precoBase = parseFloat(modal.dataset.precoBase);
        const precoTotalValorSpan = modal.querySelector(".preco-valor");
        
        let precoAdicionais = 0;
        const checkboxesMarcados = modal.querySelectorAll(".adicional-check:checked");

        checkboxesMarcados.forEach(check => {
            precoAdicionais += parseFloat(check.dataset.preco);
        });

        let precoFinal = precoBase + precoAdicionais;
        precoTotalValorSpan.textContent = precoFinal.toFixed(2).replace('.', ',');
    }

    // (2) FUNÇÃO PARA ADICIONAR AO CARRINHO (Lado do Cliente)
    function adicionarAoCarrinho(produtoId) {
        const modal = document.querySelector(`#modal-${produtoId}`);
        const nomeProduto = modal.querySelector('h4').textContent;
        const precoTotalTexto = modal.querySelector(".preco-valor").textContent;
        
        const adicionaisSelecionados = [];
        const checkboxesMarcados = modal.querySelectorAll(".adicional-check:checked");

        checkboxesMarcados.forEach(check => {
            const nomeAdicional = check.parentElement.querySelector('span > span').textContent;
            adicionaisSelecionados.push(nomeAdicional);
        });

        const itemPedido = {
            id: produtoId,
            nome: nomeProduto,
            preco: precoTotalTexto, 
            adicionais: adicionaisSelecionados
        };

        // Mostra no console o que seria "adicionado ao carrinho"
        console.log("Item adicionado ao carrinho:", itemPedido);
        
        // Dá um feedback visual para o usuário
        M.toast({html: `${nomeProduto} adicionado ao carrinho!`});
    }

    // (3) INICIALIZAÇÃO DO MATERIALIZE (ESSENCIAL)
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializa TODOS os modais que o Thymeleaf/Controller criaram
        var elems = document.querySelectorAll('.modal');
        M.Modal.init(elems, {});
    });
</script>
</body>
</html>